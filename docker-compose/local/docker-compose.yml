version: "3"
services:
  powpeg:
    build:
      context: ../powpeg
      args:
        UID: "${LPS_UID}"
    image: powpeg:latest
    container_name: powpeg01
    ports:
      - "4450:4450"
    volumes:
      - ${POWPEG_HOME:-./volumes/powpeg}/db:/home/powpeg/.rsk
      - ${POWPEG_HOME:-./volumes/powpeg}/logs:/home/powpeg/logs
    networks:
      - net_lps
    depends_on:
      rskj:
        condition: service_healthy
      bitcoind:
        condition: service_healthy
    command: [ "java", "-Drpc.providers.web.http.bind_address=0.0.0.0", "-Drpc.providers.web.cors=*", "-Drpc.providers.web.http.hosts.0=localhost",
               "-Drpc.providers.web.http.hosts.1=powpeg", "-cp", "powpeg.jar", "-Drsk.conf.file=regtest-fed.conf", "co.rsk.federate.FederateRunner", "--regtest"]
  bitcoind:
    build:
      context: ../bitcoind
      args:
        UID: "${LPS_UID}"
    image: bitcond:latest
    container_name: bitcoind01
    environment:
      - BTCD_RPC_USER
      - BTCD_RPC_PASS
    ports:
      - "5555:5555"
    volumes:
      - ${BTCD_HOME:-./volumes/bitcoind}:/home/bitcoind/.bitcoind
    networks:
      - net_lps
    command: ["bitcoind", "-rpcuser=${BTCD_RPC_USER}", "-rpcpassword=${BTCD_RPC_PASS}", "-addresstype=legacy", "-${LPS_STAGE}", "-printtoconsole", "-server",
              "-txindex", "-deprecatedrpc=signrawtransaction", "-deprecatedrpc=accounts",
              "-rpcbind=0.0.0.0", "-rpcallowip=0.0.0.0/0", "-rpcport=5555"]
  rskj:
    build:
      context: ../rskj
      args:
        UID: "${LPS_UID}"
    image: rskj:latest
    container_name: rskj01
    ports:
      - "4444:4444"
      - "4445:4445"
    volumes:
      - ${RSKJ_HOME:-./volumes/rskj}/db:/home/rsk/.rsk
      - ${RSKJ_HOME:-./volumes/rskj}/logs:/home/rsk/logs
    networks:
      - net_lps
    command: [ "java", "-Drpc.providers.web.ws.bind_address=0.0.0.0", "-Drpc.providers.web.http.bind_address=0.0.0.0", "-Drpc.providers.web.cors=*", "-Drpc.providers.web.ws.enabled=true",
               "-Drpc.providers.web.http.hosts.0=localhost", "-Drpc.providers.web.http.hosts.1=rskj", "-cp", "rskj-core.jar","-Drsk.conf.file=rsk.conf", "co.rsk.Start", "--${LPS_STAGE}" ]
  mongodb:
    image: mongo:4
    restart: on-failure
    container_name: mongo01
    environment:
      - MONGO_INITDB_ROOT_USERNAME=$MONGODB_USER
      - MONGO_INITDB_ROOT_PASSWORD=$MONGODB_PASSWORD
      - MONGO_INITDB_DATABASE=$MONGODB_DATABASE
    ports:
      - 27017:27017
    volumes:
      - ${MONGO_HOME:-./volumes/mongo}/logs:/data/db
    expose:
      - 27017
    networks:
      - net_lps


networks:
  net_lps:
    driver: "bridge"
