<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Management Login</title>
</head>
<body>
<form method="post" autocomplete="off" id="login-form">
    <input type="hidden" name="csrf" value="{{ .CsrfToken }}" required/>
    <label>Username <input type="text" name="username" required/></label>
    <label>Password <input type="password" name="password" required/></label>
    {{if not .CredentialsSet}}
    <label>New username <input type="text" name="new-username" required/></label>
    <label>New password <input type="password" name="new-password" required/></label>
    {{end}}
    <input type="submit" value="Submit" />
</form>
</body>
</html>
<script nonce="{{ .ScriptNonce }}">
    addEventListener('load', function (){
        const form = document.getElementById('login-form');
        const baseUrl = {{.BaseUrl}};
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const csrfToken = form.querySelector('input[name="csrf"]').value;
            {{if .CredentialsSet}}
            const username = form.querySelector('input[name="username"]').value;
            const password = form.querySelector('input[name="password"]').value;
            login({ baseUrl, username, password, csrfToken })
                .then(response => {
                    if (response.ok) {
                        window.location.href = window.location.href
                        console.log('Login successful');
                    } else {
                        console.error('Login failed');
                    }
                })
                .catch(e => alert('Error: '+ e.message));
            {{else}}
            const oldUsername = form.querySelector('input[name="username"]').value;
            const oldPassword = form.querySelector('input[name="password"]').value;
            const newUsername = form.querySelector('input[name="new-username"]').value;
            const newPassword = form.querySelector('input[name="new-password"]').value;
            login({ baseUrl, username: oldUsername, password: oldPassword, csrfToken })
                .then(response => {
                    if (response.ok) {
                        return setCredentials({ baseUrl, oldUsername, oldPassword, newUsername, newPassword, csrfToken })
                    } else {
                        return Promise.reject('Login failed');
                    }
                })
                .then(response => {
                    if (response.ok) {
                        console.log('Credentials set successfully');
                        window.location.href = window.location.href
                    } else {
                        return Promise.reject('Failed to set credentials');
                    }
                })
                .catch(e => alert('Error: '+ e.message));
            {{end}}
        });
    });
    function login({ baseUrl, username, password, csrfToken }) {
        return fetch(`${baseUrl}/management/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({ username, password })
        })
    }
    function setCredentials({ baseUrl, oldUsername, oldPassword, newUsername, newPassword, csrfToken }) {
        return fetch(`${baseUrl}/management/credentials`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({ oldUsername, oldPassword, newUsername, newPassword })
        })
    }
</script>