name: Update Devportal Documentation (Flyover LPS)

on:
  push:
    branches: [main]
    paths:
      - '*.md'
      - 'docs/**/*.md'
  pull_request:
    branches: [main]
    paths:
      - '*.md'
      - 'docs/**/*.md'

permissions: read-all

jobs:
  update-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1

      # Step 1: Clone the Devportal Repository
      - name: Clone Devportal Repository
        env:
          GITHUB_TOKEN: ${{ secrets.DEVPORTAL_DOCS_UPDATE_TOKEN }}
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          BRANCH_NAME="update-from-lps-${TIMESTAMP}"
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV

          git clone https://github.com/rsksmart/devportal.git
          cd devportal
          git checkout -b ${BRANCH_NAME} || git checkout ${BRANCH_NAME}
          cd ..

      # Step 2: Transform Each File and Copy to Devportal Repository
      - name: Transform Files for Devportal
        run: |
          set -e
          mkdir -p transformed

          BASE_SRC="."
          BASE_DST="devportal/docs/02-developers/06-integrate/02-flyover/LP"

          #####################################
          #  Get Started (README)            #
          #####################################
          TEMP_FILE="temp_get-started.md"
          tail -n +1 ${BASE_SRC}/README.md > ${TEMP_FILE}
          TRANSFORMED_FILE="transformed/get-started.md"
          echo "---" > ${TRANSFORMED_FILE}
          echo "sidebar_label: Getting Started" >> ${TRANSFORMED_FILE}
          echo "sidebar_position: 210" >> ${TRANSFORMED_FILE}
          echo "title: Getting Started as a Liquidity Provider" >> ${TRANSFORMED_FILE}
          echo "tags: [rsk, rootstock, rif, flyover, integrate, integration guide, rbtc, powpeg]" >> ${TRANSFORMED_FILE}
          echo "description: The Flyover SDK streamlines integration between client applications and the Flyover Protocol. This easy-to-use JavaScript/TypeScript toolkit provides configuration options for Liquidity Providers (LPs) and custom network setups for connecting to Rootstock." >> ${TRANSFORMED_FILE}
          echo "---" >> ${TRANSFORMED_FILE}
          echo "" >> ${TRANSFORMED_FILE}
          echo ":::info[Note]" >> ${TRANSFORMED_FILE}
          echo "If you wish to suggest changes on this document, please open a PR on the [Liquidity Provider Server Repository](https://github.com/rsksmart/liquidity-provider-server.git)" >> ${TRANSFORMED_FILE}
          echo ":::" >> ${TRANSFORMED_FILE}
          echo "" >> ${TRANSFORMED_FILE}
          cat ${TEMP_FILE} >> ${TRANSFORMED_FILE}
          rm ${TEMP_FILE}
          mkdir -p ${BASE_DST}
          cp ${TRANSFORMED_FILE} ${BASE_DST}/get-started.md

          #####################################
          #  Security                         #
          #####################################
          TEMP_FILE="temp_security.md"
          tail -n +1 ${BASE_SRC}/SECURITY.md > ${TEMP_FILE}
          TRANSFORMED_FILE="transformed/security.md"
          echo "---" > ${TRANSFORMED_FILE}
          echo "sidebar_label: Security Process" >> ${TRANSFORMED_FILE}
          echo "sidebar_position: 230" >> ${TRANSFORMED_FILE}
          echo "title: Liquidity Provider Server Security Process" >> ${TRANSFORMED_FILE}
          echo "tags: [rsk, rootstock, rif, flyover, integrate, integration guide, rbtc, powpeg, security]" >> ${TRANSFORMED_FILE}
          echo "description: Learn about the security process for the Liquidity Provider Server in the Flyover protocol, including vulnerability reporting, disclosure policies, and public keys." >> ${TRANSFORMED_FILE}
          echo "---" >> ${TRANSFORMED_FILE}
          echo "" >> ${TRANSFORMED_FILE}
          cat ${TEMP_FILE} >> ${TRANSFORMED_FILE}
          rm ${TEMP_FILE}
          cp ${TRANSFORMED_FILE} ${BASE_DST}/security.md

          #####################################
          #  Docker Setup                     #
          #####################################
          TEMP_FILE="temp_docker-setup.md"
          tail -n +2 ${BASE_SRC}/docker-compose/README.md > ${TEMP_FILE}
          TRANSFORMED_FILE="transformed/docker-setup.md"
          echo "---" > ${TRANSFORMED_FILE}
          echo "sidebar_label: Docker Setup" >> ${TRANSFORMED_FILE}
          echo "sidebar_position: 230" >> ${TRANSFORMED_FILE}
          echo "title: Docker Setup for Liquidity Provider Server" >> ${TRANSFORMED_FILE}
          echo "tags: [rsk, rootstock, rif, flyover, integrate, integration guide, rbtc, powpeg, docker]" >> ${TRANSFORMED_FILE}
          echo "description: Learn how to run a Liquidity Provider Server (LPS) using Docker Compose, including configuration for both regtest and testnet environments." >> ${TRANSFORMED_FILE}
          echo "---" >> ${TRANSFORMED_FILE}
          echo "" >> ${TRANSFORMED_FILE}
          cat ${TEMP_FILE} >> ${TRANSFORMED_FILE}
          rm ${TEMP_FILE}
          cp ${TRANSFORMED_FILE} ${BASE_DST}/docker-setup.md

          #####################################
          #  Protocol Design                  #
          #####################################
          TEMP_FILE="temp_design.md"
          tail -n +2 ${BASE_SRC}/docs/DESIGN.md > ${TEMP_FILE}
          TRANSFORMED_FILE="transformed/design.md"
          echo "---" > ${TRANSFORMED_FILE}
          echo "sidebar_label: Protocol Design" >> ${TRANSFORMED_FILE}
          echo "sidebar_position: 220" >> ${TRANSFORMED_FILE}
          echo "title: Flyover Protocol Design" >> ${TRANSFORMED_FILE}
          echo "tags: [rsk, rootstock, rif, flyover, integrate, integration guide, rbtc, powpeg]" >> ${TRANSFORMED_FILE}
          echo "description: The Flyover protocol allows fast Bitcoin to Rootstock transfers without giving custody of funds to third parties. Learn about the system design and workflow." >> ${TRANSFORMED_FILE}
          echo "---" >> ${TRANSFORMED_FILE}
          echo "" >> ${TRANSFORMED_FILE}
          cat ${TEMP_FILE} >> ${TRANSFORMED_FILE}
          rm ${TEMP_FILE}
          cp ${TRANSFORMED_FILE} ${BASE_DST}/design.md

          #####################################
          #  Environment Variables            #
          #####################################
          TEMP_FILE="temp_setting-variables.md"
          tail -n +2 ${BASE_SRC}/docs/Environment.md > ${TEMP_FILE}
          TRANSFORMED_FILE="transformed/setting-variables.md"
          echo "---" > ${TRANSFORMED_FILE}
          echo "sidebar_label: Environment Variables" >> ${TRANSFORMED_FILE}
          echo "sidebar_position: 230" >> ${TRANSFORMED_FILE}
          echo "title: Setting Environment Variables" >> ${TRANSFORMED_FILE}
          echo "tags: [rsk, rootstock, rif, flyover, integrate, integration guide, rbtc, powpeg]" >> ${TRANSFORMED_FILE}
          echo "description: The Flyover SDK streamlines integration between client applications and the Flyover Protocol. This easy-to-use JavaScript/TypeScript toolkit provides configuration options for Liquidity Providers (LPs) and custom network setups for connecting to Rootstock." >> ${TRANSFORMED_FILE}
          echo "---" >> ${TRANSFORMED_FILE}
          echo "" >> ${TRANSFORMED_FILE}
          cat ${TEMP_FILE} >> ${TRANSFORMED_FILE}
          rm ${TEMP_FILE}
          cp ${TRANSFORMED_FILE} ${BASE_DST}/setting-variables.md

          #####################################
          #  LP Management                    #
          #####################################
          TEMP_FILE="temp_management.md"
          tail -n +2 ${BASE_SRC}/docs/LP-Management.md > ${TEMP_FILE}
          TRANSFORMED_FILE="transformed/management.md"
          echo "---" > ${TRANSFORMED_FILE}
          echo "sidebar_label: LP Management" >> ${TRANSFORMED_FILE}
          echo "sidebar_position: 220" >> ${TRANSFORMED_FILE}
          echo "title: Liquidity Provider (LP) Management" >> ${TRANSFORMED_FILE}
          echo "tags: [rsk, rootstock, rif, flyover, integrate, integration guide, rbtc, powpeg]" >> ${TRANSFORMED_FILE}
          echo "description: The Flyover SDK streamlines integration between client applications and the Flyover Protocol. This easy-to-use JavaScript/TypeScript toolkit provides configuration options for Liquidity Providers (LPs) and custom network setups for connecting to Rootstock." >> ${TRANSFORMED_FILE}
          echo "---" >> ${TRANSFORMED_FILE}
          echo "" >> ${TRANSFORMED_FILE}
          cat ${TEMP_FILE} >> ${TRANSFORMED_FILE}
          rm ${TEMP_FILE}
          cp ${TRANSFORMED_FILE} ${BASE_DST}/management.md

          #####################################
          #  Integration Tests                #
          #####################################
          if [ -f ${BASE_SRC}/docs/integration-tests.md ]; then
            TEMP_FILE="temp_integration-tests.md"
            tail -n +2 ${BASE_SRC}/docs/integration-tests.md > ${TEMP_FILE}
            TRANSFORMED_FILE="transformed/integration-tests.md"
            echo "---" > ${TRANSFORMED_FILE}
            echo "sidebar_label: Integration Tests" >> ${TRANSFORMED_FILE}
            echo "sidebar_position: 240" >> ${TRANSFORMED_FILE}
            echo "title: Liquidity Provider Server Integration Tests" >> ${TRANSFORMED_FILE}
            echo "tags: [rsk, rootstock, rif, flyover, integrate, integration guide, rbtc, powpeg, testing]" >> ${TRANSFORMED_FILE}
            echo "description: Learn how to run integration tests for the Liquidity Provider Server (LPS) in both test instance and running instance modes." >> ${TRANSFORMED_FILE}
            echo "---" >> ${TRANSFORMED_FILE}
            echo "" >> ${TRANSFORMED_FILE}
            cat ${TEMP_FILE} >> ${TRANSFORMED_FILE}
            rm ${TEMP_FILE}
            cp ${TRANSFORMED_FILE} ${BASE_DST}/integration-tests.md
          fi

      # Step 3: Commit and Push Changes to Devportal Repository
      - name: Commit and Push Changes
        env:
          GITHUB_TOKEN: ${{ secrets.DEVPORTAL_DOCS_UPDATE_TOKEN }}
        run: |
          cd devportal
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/02-developers/06-integrate/02-flyover/LP/*
          git commit -m "Automated update from Liquidity Provider Server repository"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/rsksmart/devportal.git
          git push -f origin ${BRANCH_NAME}

      # Step 4: Create a Pull Request in the Devportal Repository
      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.DEVPORTAL_DOCS_UPDATE_TOKEN }}
        run: |
          cd devportal
          curl -L -X POST -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.DEVPORTAL_DOCS_UPDATE_TOKEN }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/rsksmart/devportal/pulls \
          -d "{\"title\":\"Liquidity-provider-server automated update of documentation ${BRANCH_NAME}\",\"body\":\"This PR updates the Devportal documentation with the latest changes from the Liquidity Provider Server repository.\",\"head\":\"${BRANCH_NAME}\",\"base\":\"main\"}"
